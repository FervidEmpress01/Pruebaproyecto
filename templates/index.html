<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora de Ahorro MN25B</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        /* Peque√±o estilo para la alerta flotante */
        #alertPlaceholder .alert {
            box-shadow: 0 4px 14px rgba(0,0,0,0.08);
        }
    </style>
</head>
<body class="bg-light">

<div class="container py-5">
    <h1 class="text-center mb-4">üí∞ Calculadora de Inter√©s Real</h1>

    <div class="row">
        <div class="col-md-4">
            <div class="card p-4 shadow-sm">
                <h4>Ingresa tus datos</h4>

                <!-- placeholder para las alertas bootstrap -->
                <div id="alertPlaceholder"></div>

                <form method="POST" id="calcForm">
                    <div class="mb-3">
                        <label>Monto Inicial ($)</label>
                        <!-- Mantengo exactamente type=number y step=any -->
                        <input type="number" step="any" name="v0" id="v0" class="form-control numeric" required placeholder="Ej: 1000">
                    </div>
                    <div class="mb-3">
                        <label>Aporte Peri√≥dico ($)</label>
                        <input type="number" step="any" name="aporte" id="aporte" class="form-control numeric" required placeholder="Ej: 100">
                    </div>
                    <div class="mb-3">
                        <label>N√∫mero de Periodos (Meses/Semanas)</label>
                        <input type="number" name="periodos" id="periodos" class="form-control numeric-int" required placeholder="Ej: 12">
                    </div>
                    <div class="mb-3">
                        <label>Meta Final Deseada ($)</label>
                        <input type="number" step="any" name="vf" id="vf" class="form-control numeric" required placeholder="Ej: 2500">
                    </div>
                    <button type="submit" class="btn btn-primary w-100">Calcular Tasa Necesaria</button>
                </form>
                
                {% if error %}
                    <div class="alert alert-danger mt-3">{{ error }}</div>
                {% endif %}
            </div>
        </div>

        <div class="col-md-8">
            {% if tasa %}
                <div class="alert alert-success">
                    <h3>‚úÖ Tasa Requerida: {{ tasa }}% por periodo</h3>
                </div>

                <ul class="nav nav-tabs" id="myTab" role="tablist">
                    <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#grafica">Gr√°fica</button></li>
                    <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabla">Tabla Detallada</button></li>
                </ul>

                <div class="tab-content bg-white p-3 border border-top-0">
                    <div class="tab-pane fade show active" id="grafica">
                        <img src="data:image/png;base64,{{ grafica }}" class="img-fluid" alt="Gr√°fica de ahorro">
                    </div>
                    <div class="tab-pane fade" id="tabla">
                        <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                            {{ tabla | safe }}
                        </div>
                    </div>
                </div>
            {% else %}
                <div class="alert alert-info">
                    Ingresa los datos a la izquierda para ver el an√°lisis num√©rico.
                </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
/*
 Validaci√≥n frontend estricta PARA NO ROMPER el comportamiento del servidor:
 - Mantengo type=number en los inputs (no toco tu backend).
 - Intercepto teclas y eventos para evitar letras, 'e', '+', '-', espacios.
 - Convierto comas a punto autom√°ticamente.
 - Evito m√°s de un punto decimal.
 - Muestro alertas Bootstrap elegantes en #alertPlaceholder cuando el usuario intenta algo prohibido.
*/

const alertPlaceholder = document.getElementById('alertPlaceholder');
let alertTimeout = null;

function showBootstrapAlert(message, type = 'warning', timeout = 3500) {
    // Limpia la alerta anterior
    clearTimeout(alertTimeout);
    alertPlaceholder.innerHTML = `
        <div class="alert alert-${type} alert-dismissible fade show" role="alert">
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    `;
    // Auto-cerrar despu√©s de timeout ms
    alertTimeout = setTimeout(() => {
        const node = alertPlaceholder.querySelector('.alert');
        if (node) {
            const bsAlert = bootstrap.Alert.getOrCreateInstance(node);
            bsAlert.close();
        }
    }, timeout);
}

// Keys permitidas: d√≠gitos, punto, comas (que convertimos), teclas de control
function isAllowedKey(event) {
    const allowedControlKeys = [
        'Backspace','ArrowLeft','ArrowRight','Delete','Tab','Home','End'
    ];
    if (allowedControlKeys.includes(event.key)) return true;
    // Digits
    if (/^[0-9]$/.test(event.key)) return true;
    // Punto y coma (coma convertimos a punto en input)
    if (event.key === '.' || event.key === ',') return true;
    return false;
}

function sanitizeValue(value, allowDecimal = true) {
    // Reemplaza comas por punto
    value = value.replace(/,/g, '.');
    // Elimina cualquier car√°cter que no sea d√≠gito o punto
    if (allowDecimal) {
        value = value.replace(/[^0-9.]/g, '');
        // Evita m√∫ltiples puntos: deja solo el primero
        const parts = value.split('.');
        if (parts.length > 1) {
            value = parts[0] + '.' + parts.slice(1).join('');
        }
    } else {
        // Para campos enteros: elimina todo lo que no sea d√≠gito
        value = value.replace(/[^0-9]/g, '');
    }
    return value;
}

// Asociamos a los inputs num√©ricos (decimales permitidos)
document.querySelectorAll('input.numeric').forEach(inp => {
    // Keydown: bloquear teclas no permitidas
    inp.addEventListener('keydown', (e) => {
        if (!isAllowedKey(e)) {
            e.preventDefault();
            showBootstrapAlert('No se permiten letras ni s√≠mbolos. Usa solo n√∫meros y punto decimal.', 'warning');
        } else {
            // Bloquear signos + y - y e/E expl√≠citamente en keydown
            if (e.key === '+' || e.key === '-' || e.key.toLowerCase() === 'e') {
                e.preventDefault();
                showBootstrapAlert('No se permiten +, - ni notaci√≥n cient√≠fica (e).', 'warning');
            }
        }
    });

    // Input: sanitizar valor (por ejemplo pegar texto)
    inp.addEventListener('input', (e) => {
        const original = inp.value;
        const cleaned = sanitizeValue(original, true);

        if (original !== cleaned) {
            inp.value = cleaned;
            showBootstrapAlert('Entrada corregida: solo se aceptan n√∫meros y un punto decimal. Las comas se convirtieron a punto.', 'warning');
        }

        // Evitar valor negativo (al pegar algo con -)
        if (inp.value.startsWith('-')) {
            inp.value = inp.value.replace(/-/g, '');
            showBootstrapAlert('No se permiten n√∫meros negativos.', 'danger');
        }
    });
});

// Para campos que deben ser enteros (periodos)
document.querySelectorAll('input.numeric-int').forEach(inp => {
    inp.addEventListener('keydown', (e) => {
        if (!isAllowedKey(e)) {
            e.preventDefault();
            showBootstrapAlert('Este campo solo acepta n√∫meros enteros (sin punto).', 'warning');
        } else {
            // bloquear punto/coma, e, +, -
            if (e.key === '.' || e.key === ',' || e.key === '+' || e.key === '-' || e.key.toLowerCase() === 'e') {
                e.preventDefault();
                showBootstrapAlert('Este campo solo acepta n√∫meros enteros. No use punto, coma, +, - ni notaci√≥n cient√≠fica.', 'warning');
            }
        }
    });

    inp.addEventListener('input', (e) => {
        const original = inp.value;
        const cleaned = sanitizeValue(original, false);

        if (original !== cleaned) {
            inp.value = cleaned;
            showBootstrapAlert('Entrada corregida: solo n√∫meros enteros permitidos.', 'warning');
        }
    });
});

// Evitar que el formulario se env√≠e si los campos est√°n vac√≠os o con un punto solo
document.getElementById('calcForm').addEventListener('submit', function (e) {
    const fields = ['v0','aporte','periodos','vf'];
    for (let name of fields) {
        const el = document.querySelector(`[name="${name}"]`);
        if (!el) continue;
        const val = el.value.trim();
        if (val === '' || val === '.' ) {
            e.preventDefault();
            showBootstrapAlert('Por favor ingresa valores v√°lidos en todos los campos antes de calcular.', 'danger');
            return false;
        }
    }
    // deja que el formulario contin√∫e (backend manejar√° conversiones/validaciones finales)
});
</script>
</body>
</html>
